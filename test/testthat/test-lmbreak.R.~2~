### test-lmbreak.R --- 
##----------------------------------------------------------------------
## Author: Brice Ozenne
## Created: Apr  6 2024 (12:19) 
## Version: 
## Last-Updated: Apr  6 2024 (22:29) 
##           By: Brice Ozenne
##     Update #: 14
##----------------------------------------------------------------------
## 
### Commentary: 
## 
### Change Log:
##----------------------------------------------------------------------
## 
### Code:

if(FALSE){
    library(testthat)
    library(segmented)   
    library(lava)   
    library(ggplot2) 

    library(lmbreak)
}

context("Compare to segmented package")

## * Comparison with segmented
## example from the pakcage
set.seed(12)
xx <- 1:100
zz <- runif(100)
yy <- 2+1.5*pmax(xx-35,0)-1.5*pmax(xx-70,0)+15*pmax(zz-.5,0)+rnorm(100,0,2)
dati <- data.frame(x=xx,y=yy,z=zz)
out.lm <- lm(y~x,data=dati)

## ggplot(dati, aes(xx, yy)) + geom_point()

test_that("Pattern 11", {

    GS.1bp <- segmented(out.lm, npsi = 1)
    test.1bp <- lmbreak(y~bp(x,"11"), data = dati)                                        

    expect_equal(coef(test.1bp, "breakpoint"), GS.1bp$psi[,"Est."], tol = 1e-3)
})

test_that("Pattern 111", {

    GS.2bp <- segmented(out.lm, npsi = 2)
    test.2bp <- lmbreak(y~bp(x,"111"), data = dati)                                        

    expect_equal(coef(test.2bp, "breakpoint"), as.double(GS.2bp$psi[,"Est."]), tol = 1e-3)
})

 
test_that("Pattern 010", {

    test.2bp.bis <- lmbreak(y~bp(x,"010"), data = dati)                                        
    test.2bp.bis <- lmbreak(y~bp(x,"010", c(35,70)), data = dati, trace = 5)                                        

    expect_equal(coef(test.2bp, "breakpoint"), as.double(GS.2bp$psi[,"Est."]), tol = 1e-3)
})

test_that("Pattern 1111", {

    GS.3bp <- segmented(out.lm, npsi = 3)
    test.3bp <- lmbreak(y~bp(x,"1111"), data = dati)                                        

    expect_equal(coef(test.3bp, "breakpoint"), as.double(GS.3bp$psi[,"Est."]), tol = 1e-3)
})

## * with plateau

test_that("Pattern 01", {
    
    set.seed(1)
    df.01 <- simBreak(c(20,50), breakpoint = c(0,1,2), slope = c(0,1), sigma = 0.1)
    ## ggplot(df.01, aes(x=X,y=Y)) + geom_point()
    test.01 <- lmbreak(Y~bp(X,"01"), data = df.01)
    expect_equal(coef(test.01, type = "breakpoint"), 0.9920744, tol = 1e-3)

    ## convergence issue
    set.seed(1)
    df.01 <- simBreak(c(10,50), breakpoint = c(0,1,2), slope = c(0,1), sigma = 0.1)
    ## ggplot(df.01, aes(x=X,y=Y)) + geom_point()
    test.01 <- lmbreak(Y~bp(X,"01"), data = df.01)
    test.11 <- lmbreak(Y~bp(X,"11"), data = df.01)
    expect_equal(coef(test.01, type = "breakpoint"), 0.9963454, tol = 1e-3)
    expect_equal(coef(test.11, type = "breakpoint"), 1.009568, tol = 1e-3)

}

test_that("Pattern 10", {
    
    set.seed(1)
    df.10 <- simBreak(c(20,50), breakpoint = c(0,1,2), slope = c(1,0), sigma = 0.1)
    ## ggplot(df.10, aes(x=X,y=Y)) + geom_point()
    test.10 <- lmbreak(Y~bp(X,"10"), data = df.10)
    expect_equal(coef(test.10, type = "breakpoint"), 0.9881715, tol = 1e-3)

}

test_that("Pattern 101", {
    
    set.seed(1)
    df.101 <- simBreak(c(20,50), breakpoint = c(0,1,2,3), slope = c(1,0,-1), sigma = 0.1)
    ## ggplot(df.101, aes(x=X,y=Y)) + geom_point()
    test.101 <- lmbreak(Y~bp(X,"101"), data = df.101)
    expect_equal(coef(test.101, type = "breakpoint"), c(0.98989381, 1.98119768), tol = 1e-3)

    set.seed(1)
    df.101 <- simBreak(c(20,50), breakpoint = c(0,1,2,4), slope = c(2,0,-1), sigma = 0.1)
    ## ggplot(df.101, aes(x=X,y=Y)) + geom_point()
    test.101 <- lmbreak(Y~bp(X,"101"), data = df.101)
    expect_equal(coef(test.101, type = "breakpoint"), c(0.99909409, 1.99933326), tol = 1e-3)
}

test_that("Pattern 010", {
    
    set.seed(1)
    df.010 <- simBreak(c(20,50), breakpoint = c(0,1,2,3), slope = c(0,1,0), sigma = 0.1)
    ## ggplot(df.010, aes(x=X,y=Y)) + geom_point()
    test.010 <- lmbreak(Y~bp(X,"101"), data = df.010, trace = 5)
    expect_equal(coef(test.010, type = "breakpoint"), c(0.98989381, 1.98119768), tol = 1e-3)

}

test_that("Pattern 1010", {
    
    set.seed(1)
    df.1010 <- simBreak(c(20,50), breakpoint = c(0,1,2,3,4), slope = c(1,0,-0.9,0), sigma = 0.1)
    ## ggplot(df.1010, aes(x=X,y=Y)) + geom_point()
    test.1010 <- lmbreak(Y~bp(X,"1010"), data = df.101, trace = 5)
    expect_equal(coef(test.1010, type = "breakpoint"), c(0.98989381, 1.98119768), tol = 1e-3)
}
##----------------------------------------------------------------------
### test-lmbreak.R ends here
